FROM node:20-alpine

WORKDIR /app

# Install dependencies for ngrok
RUN apk add --no-cache curl libc6-compat

# Install ngrok with architecture detection
RUN ARCH=$(uname -m) && \
    case "$ARCH" in \
        x86_64) NGROK_ARCH="linux-amd64" ;; \
        aarch64) NGROK_ARCH="linux-arm64" ;; \
        *) echo "Unsupported architecture: $ARCH"; exit 1 ;; \
    esac && \
    echo "Downloading ngrok for $NGROK_ARCH..." && \
    curl -Lo ngrok.tgz "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-${NGROK_ARCH}.tgz" && \
    tar -xzf ngrok.tgz -C /usr/local/bin && \
    rm ngrok.tgz && \
    ngrok --version

# Install curl and jq for extracting ngrok URL
RUN apk add --no-cache curl jq

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 4000

# Start ngrok in background, wait for it to initialize, print the URL, then start the server
CMD ngrok http 4000 --log=stdout > /dev/null & \
    sleep 4 && \
    echo "=======================================================" && \
    echo "NGROK PUBLIC URL: $(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')" && \
    echo "=======================================================" && \
    npm run dev
